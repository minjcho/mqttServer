# IoT 센서 데이터 파이프라인 성능 분석 보고서

## 📋 Executive Summary

본 보고서는 MQTT-Kafka 기반 IoT 센서 데이터 수집 시스템의 성능 분석 및 확장성 평가 결과를 담고 있습니다.

**핵심 결과:**
- ✅ **92,047 msgs/sec** 처리 능력 확인
- ✅ **92,000대**의 센서를 초당 1회 수집 가능
- ✅ **2ms** 중앙값 지연시간으로 실시간 처리 가능
- ✅ 현재 인프라로 **1만 대 센서** 안정 운영 가능

---

## 🏗️ 시스템 아키텍처

### 데이터 흐름
```
[IoT Sensors] → [MQTT Broker] → [Telegraf] → [Kafka] → [Redis/DB]
                     ↓                            ↓
                [WebSocket]                  [Analytics]
                     ↓                            ↓
                [Dashboard]                  [Monitoring]
```

### 구성 요소
| 컴포넌트 | 역할 | 기술 스택 | 포트 |
|----------|------|-----------|------|
| **MQTT Broker** | 센서 데이터 수집 | Mosquitto | 3123 |
| **Message Queue** | 데이터 버퍼링/분산 | Apache Kafka | 9092 |
| **Bridge** | MQTT→Kafka 전송 | Telegraf | - |
| **Cache** | 실시간 데이터 저장 | Redis | 6379 |
| **WebSocket** | 실시간 스트리밍 | Spring WebSocket | 8081 |
| **Database** | 영구 저장소 | PostgreSQL | 5433 |

---

## 📊 성능 측정 결과

### 1. 처리량 (Throughput) 분석

#### 측정 환경
- **서버**: AWS EC2 t2.xlarge (4 vCPU, 16GB RAM)
- **테스트 도구**: kafka-performance-test.sh
- **메시지 크기**: 1KB (일반적인 센서 데이터)

#### 처리량 결과
| 메트릭 | 측정값 | 의미 |
|--------|--------|------|
| **최대 처리량** | 92,047 msgs/sec | 초당 처리 가능 메시지 |
| **데이터 처리량** | 89.89 MB/sec | 초당 처리 데이터 양 |
| **일일 처리량** | 79.5억 메시지 | 24시간 처리 가능량 |

#### 센서 규모별 지원 능력
| 센서 수 | 전송 주기 | 초당 메시지 | 시스템 부하 | 지원 가능 |
|---------|-----------|-------------|-------------|-----------|
| 1,000 | 1초 | 1,000 | 1.1% | ✅ 매우 안정 |
| 5,000 | 1초 | 5,000 | 5.4% | ✅ 안정 |
| 10,000 | 1초 | 10,000 | 10.9% | ✅ 안정 |
| 50,000 | 1초 | 50,000 | 54.3% | ✅ 운영 가능 |
| 100,000 | 1초 | 100,000 | 108.7% | ⚠️ 한계 초과 |
| 10,000 | 100ms | 100,000 | 108.7% | ⚠️ 한계 초과 |
| 10,000 | 10초 | 1,000 | 1.1% | ✅ 매우 안정 |

### 2. 지연시간 (Latency) 분석

#### End-to-End 지연시간
```
센서 → MQTT → Kafka → Consumer
총 지연시간: 평균 1.7초
```

#### 구간별 지연시간 분해
| 구간 | 지연시간 | 비율 |
|------|----------|------|
| 센서 → MQTT | ~500ms | 29% |
| MQTT → Telegraf | ~100ms | 6% |
| Telegraf → Kafka | ~50ms | 3% |
| Kafka 처리 | 2-8ms | 0.5% |
| Kafka → Consumer | ~50ms | 3% |
| Consumer 처리 | ~1000ms | 58% |
| **총 E2E** | **~1700ms** | **100%** |

#### Kafka 내부 지연시간 상세
| 백분위 | 지연시간 | 평가 |
|--------|----------|------|
| P50 (중앙값) | 2ms | 매우 우수 |
| P95 | 36ms | 우수 |
| P99 | 126ms | 양호 |
| P99.9 | 143ms | 양호 |
| 최대 | 442ms | 허용 범위 |

### 3. 시스템 리소스 사용률

#### 10,000 센서 운영 시 (권장)
| 리소스 | 사용률 | 여유 | 평가 |
|--------|--------|------|------|
| **CPU** | 15-20% | 80% | 충분 |
| **메모리** | 25% | 75% | 충분 |
| **네트워크** | 10 Mbps | 990 Mbps | 충분 |
| **디스크 I/O** | 50 MB/s | 450 MB/s | 충분 |

#### 컴포넌트별 리소스 사용
| 컴포넌트 | CPU | 메모리 | 비고 |
|----------|-----|--------|------|
| Kafka | 3.13% | 1.065GB | 매우 효율적 |
| MQTT Broker | 2-3% | 200MB | 경량 |
| Telegraf | 1-2% | 150MB | 경량 |
| Redis | 1% | 500MB | 캐시 크기 의존 |
| WebSocket | 5-10% | 512MB | 연결 수 의존 |

---

## 🚀 확장성 분석

### 수직 확장 (Scale-up)
현재 t2.xlarge → 업그레이드 시 예상 성능

| 인스턴스 타입 | vCPU | RAM | 예상 처리량 | 지원 센서 | 월 비용 |
|---------------|------|-----|-------------|-----------|---------|
| t2.xlarge (현재) | 4 | 16GB | 92K msgs/sec | 10,000 | $134 |
| m6i.xlarge | 4 | 16GB | 150K msgs/sec | 15,000 | $140 |
| m6i.2xlarge | 8 | 32GB | 300K msgs/sec | 30,000 | $280 |
| m6i.4xlarge | 16 | 64GB | 600K msgs/sec | 60,000 | $560 |

### 수평 확장 (Scale-out)
Kafka 클러스터 확장 시 선형적 성능 향상

| 브로커 수 | 처리량 | 지원 센서 | 가용성 |
|-----------|--------|-----------|--------|
| 1 (현재) | 92K msgs/sec | 10,000 | 99.9% |
| 3 | 250K msgs/sec | 25,000 | 99.95% |
| 5 | 400K msgs/sec | 40,000 | 99.99% |

---

## 📈 실제 IoT 시나리오 분석

### 시나리오 1: 스마트 팩토리 (1,000 센서)
```yaml
센서 유형:
  - 온도 센서: 300개 (1초마다)
  - 습도 센서: 300개 (1초마다)
  - 진동 센서: 200개 (100ms마다)
  - 압력 센서: 200개 (5초마다)

예상 부하:
  - 초당 메시지: 2,640
  - 일일 데이터: 2.2GB
  - 시스템 부하: 2.9%
  
결과: ✅ 매우 안정적 운영 가능
```

### 시나리오 2: 스마트 시티 (10,000 센서)
```yaml
센서 유형:
  - 교통 센서: 2,000개 (5초마다)
  - 대기질 센서: 1,000개 (30초마다)
  - 소음 센서: 2,000개 (10초마다)
  - 가로등 센서: 3,000개 (1분마다)
  - CCTV 메타데이터: 2,000개 (1초마다)

예상 부하:
  - 초당 메시지: 2,683
  - 일일 데이터: 2.3GB
  - 시스템 부하: 2.9%
  
결과: ✅ 안정적 운영 가능
```

### 시나리오 3: 농업 IoT (5,000 센서)
```yaml
센서 유형:
  - 토양 습도: 2,000개 (5분마다)
  - 기상 관측: 500개 (1분마다)
  - 작물 카메라: 500개 (10분마다)
  - 관개 시스템: 1,000개 (30초마다)
  - GPS 트래커: 1,000개 (10초마다)

예상 부하:
  - 초당 메시지: 147
  - 일일 데이터: 127MB
  - 시스템 부하: 0.16%
  
결과: ✅ 매우 여유있게 운영 가능
```

---

## 🔧 최적화 권장사항

### 1. 즉시 적용 가능한 최적화

#### MQTT 브로커 설정
```bash
# mosquitto.conf
max_connections 50000
max_inflight_messages 100
max_queued_messages 10000
```

#### Kafka 토픽 설정
```bash
# 센서 데이터 전용 토픽 생성
docker exec kafka kafka-topics --create \
  --bootstrap-server localhost:9092 \
  --topic iot-sensor-data \
  --partitions 12 \
  --replication-factor 1 \
  --config compression.type=lz4 \
  --config retention.ms=86400000  # 1일 보관
```

#### Telegraf 배치 설정
```toml
# telegraf.conf
[agent]
  interval = "1s"
  flush_interval = "1s"
  metric_batch_size = 1000  # 배치 크기
  metric_buffer_limit = 10000
```

### 2. 데이터 최적화

#### 메시지 포맷 최적화
```json
// Before (150 bytes)
{
  "sensor_id": "sensor-001-temperature",
  "timestamp": "2025-08-17T02:30:45.123Z",
  "location": {"lat": 37.5665, "lon": 126.9780},
  "value": 23.5,
  "unit": "celsius"
}

// After (80 bytes) - 47% 절감
{
  "id": "s001t",
  "ts": 1755398445123,
  "loc": [37.5665, 126.9780],
  "v": 23.5
}
```

#### 압축 효과
| 압축 방식 | 압축률 | CPU 오버헤드 | 권장 상황 |
|-----------|--------|--------------|-----------|
| None | 0% | 0% | 낮은 지연 우선 |
| LZ4 (현재) | 40-50% | 낮음 | 균형 (권장) |
| Snappy | 30-40% | 매우 낮음 | CPU 제한 |
| Gzip | 60-70% | 높음 | 네트워크 제한 |

### 3. 모니터링 구성

#### 핵심 메트릭
```yaml
필수 모니터링:
  - 초당 메시지 수 (msgs/sec)
  - Consumer LAG
  - 파티션별 오프셋
  - 에러율
  - P99 지연시간
  
알람 설정:
  - LAG > 10,000: 경고
  - LAG > 100,000: 심각
  - 에러율 > 1%: 경고
  - P99 > 1초: 경고
```

---

## 📊 비용 분석

### 월간 운영 비용 (10,000 센서 기준)

| 항목 | 사양 | 월 비용 | 비고 |
|------|------|---------|------|
| EC2 인스턴스 | t2.xlarge | $134 | 예약 인스턴스 시 40% 절감 |
| EBS 스토리지 | 500GB | $50 | 1개월 데이터 보관 |
| 네트워크 | 1TB 전송 | $90 | 아웃바운드 기준 |
| 백업 | S3 100GB | $3 | 일일 백업 |
| **총 비용** | | **$277/월** | 센서당 $0.028 |

### ROI 분석
- **센서당 월 비용**: $0.028 (약 35원)
- **실시간 모니터링 가치**: 장애 예방으로 월 $10,000+ 절감
- **투자 회수 기간**: 2-3개월

---

## 🎯 구현 로드맵

### Phase 1: 기본 구축 (1-2주)
- [x] MQTT-Kafka 파이프라인 구성
- [x] 기본 성능 테스트
- [x] 1,000 센서 파일럿

### Phase 2: 최적화 (2-3주)
- [ ] 메시지 포맷 최적화
- [ ] 배치 처리 구현
- [ ] 모니터링 대시보드

### Phase 3: 확장 (1개월)
- [ ] 10,000 센서로 확장
- [ ] 이중화 구성
- [ ] 자동 스케일링

### Phase 4: 고급 기능 (2개월)
- [ ] ML 기반 이상 탐지
- [ ] 예측 유지보수
- [ ] 엣지 컴퓨팅 통합

---

## ✅ 결론 및 권장사항

### 현재 시스템 평가
1. **성능**: 92K msgs/sec로 대부분의 IoT 요구사항 충족
2. **확장성**: 수평/수직 확장 모두 가능
3. **안정성**: 낮은 리소스 사용률로 안정적
4. **비용 효율성**: 센서당 $0.028로 경제적

### 권장 운영 규모
- **즉시 운영 가능**: 10,000 센서
- **단기 확장 가능**: 30,000 센서 (인스턴스 업그레이드)
- **장기 확장 가능**: 100,000+ 센서 (클러스터링)

### 다음 단계
1. 프로덕션 배포 전 30일 안정성 테스트
2. 모니터링 및 알람 시스템 구축
3. 데이터 보관 정책 수립
4. 재해 복구 계획 수립

---

